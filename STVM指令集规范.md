# STVM指令集规范

* 内部版本 1.0

该文档仅提供指令集和指令相应格式。对于指令相应的编码等事项，将会自行实现或后续更新。

### 数据结构

* 对象内存：对象所在内存
* 操作数栈：该栈用于存放临时值（请在GC时不要删除操作数栈中的对象及其相关对象）
* 运行内存：虚拟机运行时占用的内存，包含了对象所在内存和操作数栈
* 常量：代码中的字面量、标识符都是常量
* 常量表：由常量组成的表格，通常位于文件头，故此文档不再赘述
* 常量索引：常量在常量表中所在的位置（为一个整数），指令集当中的所有参数在未经特殊声明的情况下都是常量索引
* 作用域栈：该栈用于存储运行时作用域，每个运行时作用域都有一张以标识符的常量索引为键，以对象为值的符号表

在未经特殊声明的情况下，对栈的操作默认为对操作数栈的操作。

### 内存操作

* push x：将x压操作数栈
* peek x：将栈顶传递给x。**目前该指令不会得到应用，但是以后可能会，所以先留着**
* pop：弹出栈顶
* assign：将栈顶元素赋值给栈顶下一元素，弹出两个元素
* member：获取以栈顶下一元素为容器，以栈顶元素为成员标识符的成员对象，弹出两个元素后将该值压入栈
* index：获取以栈顶下一元素为数列，以栈顶元素为下标的元素，弹出两个元素后将该值压入栈
* new：以栈顶元素为类，新建一个类对象，弹出一个元素，并把新建的类对象元素压入

### 运算

以下双目运算符指令会以栈顶下一元素作为第一运算数，栈顶元素作为第二运算数，进行双目运算后弹出两个元素，并把运算结果压入栈。

* add：加
* sub：减
* mul：乘
* div：除
* mod：取余
* lsh：左移
* rsh：右移
* less：小于
* lequ：小等于
* big：大于
* bequ：大等于
* equ：判等
* iequ：判不等
* band：按位与
* bxor：按位异或
* bor：按位或
* land：逻辑与
* lor：逻辑或

以下单目运算符指令会以栈顶元素作为运算数，进行单目运算后弹出一个元素，并把运算结果压入栈。

* pos：正
* neg：负
* cpl：按位取反
* not：逻辑非


### 数据结构

* def：以栈顶元素为标识符，在该作用域下定义一个变量（并赋值为null）
* func ...代码... end ：定义一个函数对象，栈顶元素n代表参数个数，栈顶下1~n个元素代表函数参数的标识符（栈顶下n个元素为第一个参数，栈顶下1个元素为最后一个参数），弹出n+1个元素后将函数对象压入栈。其中“...代码...”为函数体代码。
* class ...代码... end：定义一个类对象，栈顶元素n代表成员个数，栈顶下1~n个元素代表类成员的标识符，弹出n+1个元素后将类压入栈。其中“...代码...”为初始化类的代码（包括但不限于成员变量赋值、成员函数赋值等），在新建类对象时，会先初始化类的代码，再执行类的__init__函数（如果有的话）
* end：表示代码结束的助记符。
* array：以栈顶元素为长度，建立一个数列，弹出一个元素并把新建的数列压入栈。
* * array：以栈顶元素n为长度，栈顶下1~n元素为内容，建立一个数列，弹出一个元素并把新建的数列压入栈。（栈顶下n个元素为第一个数列元素，栈顶下1个元素为最后一个数列元素）

### 流程控制

以下的跳转指令在跳转时会向作用域栈压入一个新的作用域。

* if x：如果栈顶元素不是0或null，那么向下跳转x条指令（不包含本条指令），如果x是负数，那么向上跳转-x条指令（不包含本指令）
* goto x：无条件向下跳转x条指令，如果x是负数，那么向上跳转-x条指令（不包含本指令）
* call：以栈顶元素为函数，无条件调用。调用时会弹出n+1个元素（其中n为函数参数个数，如果是成员函数，则不包含self），并以这些元素为参数调用函数（栈顶下n个元素为第一个参数，栈顶下1个元素为最后一个参数）
* return：以栈顶元素为返回值，向作用域栈弹出一个作用域并退出函数。该指令不会弹出任何元素。

### 特别的...

* sfn：以栈顶下一元素为端口号，栈顶元素为参数变量，调用sfn（具体请见其他文档），在调用sfn后弹出两个元素。